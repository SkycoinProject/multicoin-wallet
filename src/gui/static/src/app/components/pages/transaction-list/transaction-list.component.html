<app-header [headline]="'history.title-and-button' | translate"></app-header>

<!-- Message shown if there are no wallets. -->
<div class="container" *ngIf="!userHasWallets">
  <app-loading-content
    [isLoading]="false"
    [noDataText]="'history.no-txs'"
  ></app-loading-content>
</div>

<!-- Content. -->
<div class="container" [ngClass]="{disabled: loadingTransactions && transactionsLoadedForTheFirsTime}" *ngIf="userHasWallets">
  <!-- Filtering options. -->
  <div [formGroup]="form" class="form-field" [ngClass]="{ 'bottom-line': !transactions || transactions.length === 0 }" *ngIf="transactionsLoadedForTheFirsTime">
    <mat-select
      multiple
      formControlName="filter"
      [placeholder]="'history.no-filter' | translate"
      id="filter"
    >
      <!-- Filter groups for the wallets showing all addresses. -->
      <mat-optgroup *ngFor="let wallet of walletsShowingAllAddresses" label="
        {{ wallet.label }} - {{ wallet.coins | amount }}
        {{ !coinHasHours ? '' : ' (' + (wallet.hours | amount:false) + ')' }}
      ">
        <mat-option appMainColorFormElement *ngIf="wallet.addresses.length > 1" [value]="wallet">
          {{ 'history.all-addresses' | translate }}
        </mat-option>
        <mat-option appMainColorFormElement *ngFor="let address of wallet.addresses" [value]="address" [disabled]="wallet.allAddressesSelected">
          {{ address.printableAddress }} - {{ address.coins | amount }}
          {{ !coinHasHours ? '' : ' (' + (address.hours | amount:false) + ')' }}
        </mat-option>
      </mat-optgroup>
      <!-- Filter group for all wallets not showing addresses. -->
      <mat-optgroup
        *ngIf="walletsNotShowingAddresses.length > 0"
        [label]="('history.' + (walletsShowingAllAddresses.length > 0 ? 'other-wallets' : 'wallets') + '-title') | translate"
      >
        <ng-container *ngFor="let wallet of walletsNotShowingAddresses">
          <mat-option appMainColorFormElement [value]="wallet">
            {{ wallet.label }} - {{ wallet.coins | amount }}
            {{ !coinHasHours ? '' : ' (' + (wallet.hours | amount:false) + ')' }}
          </mat-option>
        </ng-container>
      </mat-optgroup>
      <!-- Filter group for all the addresses shown independently. -->
      <mat-optgroup *ngIf="addresses.length > 0" [label]="'history.addresses' | translate">
        <mat-option appMainColorFormElement *ngFor="let address of addresses" [value]="address" [disabled]="address.showingWholeWallet">
          {{ address.walletName }} - {{ address.printableAddress }} - {{ address.coins | amount }}
          {{ !coinHasHours ? '' : ' (' + (address.hours | amount:false) + ')' }}
        </mat-option>
      </mat-optgroup>
      <!-- Content for showing the selected filters. -->
      <mat-select-trigger>
        <span *ngIf="form.get('filter').value.length === 1">{{ 'history.filter' | translate }}</span>
        <span *ngIf="form.get('filter').value.length > 1">{{ 'history.filters' | translate }}</span>
        <ng-container *ngFor="let filter of form.get('filter').value; let i = index">
          <div class="filter text-truncate" *ngIf="filter.label || !filter.showingWholeWallet">
            <span *ngIf="filter.label">{{ filter.label }}</span>
            <span *ngIf="filter.walletName">{{ filter.walletName }} - </span>
            <span *ngIf="filter.printableAddress">{{ filter.printableAddress }}</span>
            - {{ filter.coins | amount }}
            {{ !coinHasHours ? '' : ' (' + (filter.hours | amount:false) + ')' }}
          </div>
        </ng-container>
      </mat-select-trigger>
    </mat-select>
    <img class="x-button image-button" src="assets/img/delete-grey.png" (click)="removeFilters()" *ngIf="form.get('filter').value.length > 0">
    <mat-icon appThemeColorText [showOnlyIfMouseOver]="true" class="options-button" [inline]="true" [matMenuTriggerFor]="optionsMenu" *ngIf="userHasMultipleWallets">more_vert</mat-icon>
    <mat-menu #optionsMenu="matMenu" [overlapTrigger]="false">
      <button mat-menu-item (click)="switchAddressesVisibility()">
        {{ ('history.' + (showAddresses ? 'hide' : 'show') + '-addresses') | translate }}
      </button>
    </mat-menu>
  </div>

  <app-loading-content
    [isLoading]="!transactionsLoadedForTheFirsTime"
    [noDataText]="!allTransactions || allTransactions.length === 0 ? 'history.no-txs' : 'history.no-txs-filter'"
    *ngIf="!transactions || transactions.length === 0"
  ></app-loading-content>

  <!-- Transaction list. -->
  <div class="paper" *ngIf="transactions && transactions.length > 0">
    <ng-container *ngFor="let transaction of transactions">
      <div class="-transaction-container" (click)="showTransaction(transaction)"><div class="-transaction" [ngClass]="{ '-pending': !transaction.confirmed }">
        <!-- Icon. -->
        <div class="-icon">
          <img *ngIf="transaction.confirmed" appImageColor [src]="'assets/img/' + getTransactionIconName(transaction) + '-configurable.png'">
          <img *ngIf="!transaction.confirmed" [src]="'assets/img/' + getTransactionIconName(transaction) + '-configurable.png'" class="-pending">
        </div>
        <div class="-address">
          <!-- First line. -->
          <h4 [ngClass]="{'red-text': transaction.failed}">
            <ng-container *ngIf="transaction.failed">
              <span>{{ 'history.failed' | translate }}</span>
              <mat-icon [matTooltip]="'history.failed-info' | translate" [inline]="true">help</mat-icon>
              <span> - </span>
            </ng-container>
            <ng-container *ngIf="transaction.type === oldTransactionTypes.Outgoing">
              {{ ('history.' + (transaction.confirmed ? 'sent' : 'sending')) | translate:{coinName: ('coinSymbol' | commonText)} }}
            </ng-container>
            <ng-container *ngIf="transaction.type === oldTransactionTypes.Incoming">
              {{ ('history.' + (transaction.confirmed ? 'received' : 'receiving')) | translate:{coinName: ('coinSymbol' | commonText)} }}
            </ng-container>
            <ng-container *ngIf="transaction.type === oldTransactionTypes.MovedBetweenAddresses">
              {{ ('history.' + (transaction.confirmed ? 'moved' : 'moving')) | translate:{coinName: ('coinSymbol' | commonText)} }}
            </ng-container>
            <ng-container *ngIf="transaction.type === oldTransactionTypes.MovedBetweenWallets">
              {{ ('history.' + (transaction.confirmed ? 'moved-wallet' : 'moving-wallet')) | translate:{coinName: ('coinSymbol' | commonText)} }}
            </ng-container>
            <ng-container *ngIf="transaction.type === oldTransactionTypes.MixedOrUnknown">
              {{ 'history.complex-transaction' | translate }}
            </ng-container>
            <!-- Involved wallets, if the addresses are being shown. -->
            <span class="wallets-text" *ngIf="showAddresses && userHasMultipleWallets">
              {{ ('history.involved-wallet' + (transaction.numberOfInvolvedLocalWallets !== 1 ? 's' : '') + '-small-label') | translate }}
              <span>{{ transaction.involvedLocalWallets }}</span>
            </span>
          </h4>
          <!-- Addresses. -->
          <ng-container *ngIf="showAddresses">
            <div class="-item" *ngFor="let address of transaction.relevantAddresses">
              <app-qr-code-button [address]="address"></app-qr-code-button>
              <span class="break-all">{{ address }}</span>
            </div>
          </ng-container>
          <!-- Note. -->
          <div class="-item" *ngIf="transaction.note">
            <span>{{ 'history.transaction-note-small-label' | translate }} <span class="black-text">{{ transaction.note }}</span></span>
          </div>
          <!-- Involved wallets, if the addresses are not being shown. -->
          <div class="-item" *ngIf="!showAddresses">
            <span>
              {{ ('history.involved-wallet' + (transaction.numberOfInvolvedLocalWallets !== 1 ? 's' : '') + '-small-label') | translate }}
              <span class="black-text">{{ transaction.involvedLocalWallets }}</span>
            </span>
          </div>
        </div>
        <div class="-balance">
          <div class="-top-line" *ngIf="transaction.confirmed">{{ transaction.timestamp | dateTime }}</div>
          <div class="-top-line red-text" *ngIf="!transaction.confirmed">
            {{ 'history.pending-indication' | translate:{currentConfirmations: transaction.confirmations, confirmationsNeeded: confirmationsNeeded} }}
            <mat-icon
              [matTooltip]="'history.confirmations-help' | translate:{currentConfirmations: transaction.confirmations, confirmationsNeeded: confirmationsNeeded}"
              [inline]="true"
            >
              help
            </mat-icon>
          </div>
          <ng-container *ngIf="transaction.type !== oldTransactionTypes.MixedOrUnknown">
            <h4>
              {{ transaction.balance.toString() | amount }}
              <mat-icon
                *ngIf="!coinHasHours &&
                       (transaction.type === oldTransactionTypes.Outgoing ||
                       transaction.type === oldTransactionTypes.MovedBetweenAddresses ||
                       transaction.type === oldTransactionTypes.MovedBetweenWallets)"
                [matTooltip]="'history.balance-help' | translate:{amount: (transaction.fee | amount)}"
                [inline]="true"
              >
                help
              </mat-icon>
            </h4>
            <p *ngIf="price" [matTooltip]="'tx.current-rate-help' | translate">
              {{ transaction.balance * price | currency:'USD':'symbol':'1.2-2' }}<span>*</span>
            </p>
            <div *ngIf="coinHasHours" class="burned">
              <p [matTooltip]="'tx.hours-burned-help' | translate:{hoursName: ('hours' | commonText)}">
                <mat-icon [inline]="true">whatshot</mat-icon>
                {{ transaction.fee | amount:false:'first' }}
              </p>
            </div>
          </ng-container>
        </div></div>
      </div>
    </ng-container>
    <div appThemeColorText *ngIf="viewingTruncatedList && !someTransactionsWereIgnored" class="view-all-button" (click)="showAll()">
      {{ 'history.view-all' | translate:{ number:totalElements } }}
    </div>
    <div appThemeColorText *ngIf="someTransactionsWereIgnored && showingStep !== showingSteps.All" class="view-all-button" (click)="loadMore()">
      {{ 'history.load-more' | translate }}
      <mat-spinner appMainColorFormElement *ngIf="loadingTransactions"></mat-spinner>
    </div>

    <a
      appThemeColorText
      *ngIf="someTransactionsWereIgnored && showingStep === showingSteps.All && currentCoin.explorerUrl"
      class="view-all-button"
      [href]="currentCoin.explorerUrl"
      target="_blank"
      rel="noreferrer nofollow noopener"
    >
      {{ 'history.use-explorer' | translate }}
    </a>
    <div appThemeColorText *ngIf="someTransactionsWereIgnored && showingStep === showingSteps.All && !currentCoin.explorerUrl" class="view-all-button no-selectable">
      {{ 'history.use-explorer' | translate }}
    </div>
  </div>
</div>
